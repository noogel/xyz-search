<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>LLM流式对话演示</title>
    <meta id="csrf-token" name="csrf-token" th:content="${_csrf.token}" th:if="${_csrf}">
    <!-- 引入Bootstrap 5 -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 70vh;
            overflow-y: auto;
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
        }
        .user-message {
            background: #007bff;
            color: white;
            margin-left: 20%;
        }
        .bot-message {
            background: #e9ecef;
            margin-right: 20%;
        }
        .message-card {
            max-width: 80%;
            transition: opacity 0.3s;
        }
        .typing-indicator {
            display: none;
            padding: 10px;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <div class="chat-container mb-3" id="chatBox"></div>

    <div class="input-group">
        <textarea id="inputMessage" class="form-control"
                  placeholder="输入消息..." rows="2"></textarea>
        <button id="btnSend" class="btn btn-primary">
            发送
        </button>
    </div>

    <!-- 加载指示器 -->
    <div id="typingIndicator" class="typing-indicator">
        <div class="spinner-border spinner-border-sm" role="status"></div>
        <span class="ms-2">思考中...</span>
    </div>
</div>

<!-- 引入jQuery和Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
    $(document).ready(function() {
        const API_ENDPOINT = "/ai/chat/stream"; // 替换为实际API地址

        // 消息发送处理
        $('#btnSend').click(async function() {
            const message = $('#inputMessage').val().trim();
            if (!message) return;

            // 禁用按钮防止重复提交
            $(this).prop('disabled', true);
            $('#typingIndicator').show();

            // 添加用户消息
            appendMessage(message, 'user');
            $('#inputMessage').val('');

            try {
                // 创建AI消息占位符
                const botMsgElement = appendMessage(' ', 'bot');

                // 发起流式请求
                const xhr = new XMLHttpRequest();
                xhr.open('POST', API_ENDPOINT);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('x-csrf-token', document.head.querySelector('meta[name="csrf-token"]').content);

                // 流式数据处理
                let uuid = '';
                xhr.onprogress = function() {
                    if (xhr.readyState === 3) {
                        // 按换行符分割响应块（需与后端约定格式）
                        const chunks = xhr.responseText.split('data:');
                        chunks.slice(-2, -1).forEach(chunk => {
                            const cleanedChunk = chunk.replace(/^data:/, '');
                            // 二次验证处理后的内容有效性
                            if (cleanedChunk.trim().length === 0) {
                                return;
                            }
                            const data = JSON.parse(cleanedChunk);
                            if ( uuid == data.uuid) {
                                return;
                            }
                            let content = data.content;
                            if ( '\n\n' == content) {
                                content = '<br>'
                            }
                            botMsgElement.textContent += content;
                            uuid = data.uuid;
                        });

                        // 自动滚动到底部
                        $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                    }
                };

                xhr.onload = function() {
                    if (xhr.status === 200) {
                        $('#typingIndicator').hide();
                    }
                };

                xhr.send(JSON.stringify({ message: message }));
            } catch (error) {
                console.error('请求失败:', error);
                appendMessage('服务暂时不可用，请稍后再试', 'bot');
            } finally {
                $('#btnSend').prop('disabled', false);
            }
        });

        // 消息框回车发送
        $('#inputMessage').keypress(function(e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                $('#btnSend').click();
            }
        });

        // 添加消息到对话框
        function appendMessage(content, role) {
            const isUser = role === 'user';
            const msgElement = $(
                `<div class="message-card card mb-2 ${isUser ? 'user-message ms-auto' : 'bot-message'}">
                    <div class="card-body p-2">${content}</div>
                 </div>`
            );
            $('#chatBox').append(msgElement);
            return msgElement.find('.card-body')[0];
        }
    });
</script>
</body>
</html>